# Twitter 监控系统诊断和检查清单

## 🔍 问题诊断

### 当前问题
您提到"没看到 X API 有调用次数的减少"，可能有以下几个原因：

---

## ✅ 完整检查流程

### 1. Twitter API 配置检查

#### 检查 API 密钥是否正确

**Railway 环境变量检查**：
1. 登录 Railway 控制台
2. 进入你的 Web 服务
3. 点击 **"Variables"** 标签
4. 确认以下变量存在：
   ```bash
   TWITTER_BEARER_TOKEN=你的token
   TWITTER_API_KEY=你的key
   TWITTER_API_SECRET=你的secret
   ```

**使用新的测试功能**：
- 访问：`/twitter/logs/`
- 点击 **"测试 API 连接"** 按钮
- 查看测试结果

#### 检查 API 权限级别

**免费版限制**：
- ❌ **无法使用** `get_users_tweets` 等端点
- ❌ **无法获取**用户信息
- ✅ **可以使用** 基础搜索功能

**Basic 版 ($100/月)**：
- ✅ 可以获取用户推文
- ✅ 可以搜索回复
- ✅ 每月 50,000 条推文配额

**检查方法**：
1. 访问 https://developer.twitter.com/en/portal/dashboard
2. 查看你的订阅级别
3. 查看 API 使用量统计

### 2. 监控任务执行检查

#### 2.1 检查 Redis 是否运行

**Railway 检查**：
- 确认已添加 Redis 服务
- 查看 Redis 服务状态是否 "Active"

**环境变量检查**：
```bash
REDIS_URL=redis://default:xxx@redis.railway.internal:6379
```

#### 2.2 检查 Celery Worker 是否运行

**当前问题**：
- ⚠️ **定时任务无法自动执行**，因为没有配置 Celery Worker 和 Beat 服务

**解决方案**：

**方式 1：完整配置（推荐）**

在项目根目录创建 `Procfile`：
```procfile
web: gunicorn mysite.wsgi:application
worker: celery -A mysite worker --loglevel=info
beat: celery -A mysite beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
```

在 Railway 创建 3 个服务：
1. Web - 运行网站
2. Worker - 处理后台任务
3. Beat - 调度定时任务

**方式 2：手动触发（临时方案）**
- 访问 `/twitter/monitor-config/`
- 点击"启动监控"按钮
- 系统会立即执行一次监控

#### 2.3 查看执行日志

**新功能**：
- 访问：`/twitter/logs/`
- 查看所有监控任务的执行记录
- 包括：
  - 执行时间
  - 成功/失败状态
  - 抓取的推文数量
  - 错误信息

### 3. API 调用问题诊断

#### 3.1 检查 API 调用是否正确

**关键问题**：当前代码调用的是 Twitter API v2，需要 **Basic 订阅级别**

**免费版无法使用的端点**：
```python
# ❌ 免费版不可用
client.get_user(username='xxx')          # 获取用户信息
client.get_users_tweets(id='xxx')        # 获取用户推文
client.search_recent_tweets(query='xxx') # 搜索推文
```

**检查方法**：
1. 访问 `/twitter/logs/`
2. 点击"测试 API 连接"
3. 查看返回的错误信息：
   - 如果显示 "403 Forbidden"  → API 权限不足，需要升级
   - 如果显示 "401 Unauthorized" → API 密钥错误
   - 如果显示用户信息 → API 工作正常

#### 3.2 验证 API 调用次数

**Twitter API 使用量查看**：
1. 访问：https://developer.twitter.com/en/portal/dashboard
2. 点击你的项目
3. 查看 "Usage" 标签
4. 查看实时调用统计

**如果调用次数没有变化**：
- ❌ 监控任务没有实际执行
- ❌ API 权限不足，请求被拒绝
- ❌ 环境变量配置错误

### 4. 数据库检查

#### 检查是否有数据写入

**Django Admin 检查**：
1. 访问：`/admin/`
2. 登录后查看：
   - **Monitored users** - 监控用户列表
   - **Tweets** - 推文数据
   - **Monitor logs** - 监控日志

**如果没有数据**：
- 监控任务没有执行
- API 调用失败
- 数据保存失败

---

## 🎯 推荐的诊断步骤

### 第1步：测试 API 连接

1. 访问：`/twitter/logs/`
2. 点击"测试 API 连接"按钮
3. 查看结果：

**成功示例**：
```json
{
  "user_id": "783214",
  "username": "Twitter",
  "display_name": "Twitter",
  "api_working": true
}
```

**失败示例**：
```
错误：403 Forbidden - You currently have access to a subset of Twitter API v2 endpoints
原因：免费版 API 无法使用
解决：升级到 Basic 级别
```

### 第2步：手动触发监控

1. 访问：`/twitter/add-user/`
2. 添加一个测试用户（例如：`Twitter`）
3. 访问：`/twitter/monitor-config/`
4. 选择用户，点击"启动监控"
5. 访问：`/twitter/logs/`
6. 查看执行结果

**预期结果**：
- ✅ 如果 API 可用：日志显示"成功"，推文数 > 0
- ❌ 如果 API 不可用：日志显示"失败"，有错误信息

### 第3步：检查 Railway 服务

确认以下服务都在运行：
- ✅ Web 服务（Django）
- ✅ PostgreSQL 数据库
- ✅ Redis 数据库
- ⚠️ Celery Worker（需要添加）
- ⚠️ Celery Beat（需要添加）

### 第4步：查看详细日志

**Railway 日志查看**：
1. 进入 Railway 项目
2. 点击 Web 服务
3. 点击 "Deployments"
4. 点击最新的部署
5. 查看 "Logs" 标签
6. 搜索关键词：
   - `Twitter API`
   - `monitor_user`
   - `ERROR`
   - `403`

---

## 🔧 常见问题和解决方案

### 问题 1：API 调用次数没有减少

**可能原因**：
1. **免费版 API** - 请求被拒绝，不计入调用次数
2. **监控任务未执行** - 没有配置 Celery Beat
3. **API 密钥错误** - 请求失败

**解决方法**：
1. 访问 `/twitter/logs/` 查看执行记录
2. 点击"测试 API 连接"验证
3. 检查 Twitter Developer Portal 的使用统计
4. 查看错误日志确定具体问题

### 问题 2：监控任务不执行

**可能原因**：
1. Redis 未启动
2. Celery Worker 未运行
3. Celery Beat 未配置

**解决方法**：
1. 在 Railway 添加 Redis 服务
2. 配置 Procfile 启动 Worker 和 Beat
3. 或使用手动触发方式

### 问题 3：推文数据为 0

**可能原因**：
1. 免费 API 无法访问推文端点
2. 用户最近没有发推文
3. `since_id` 设置导致没有新推文

**解决方法**：
1. 升级 API 到 Basic 级别
2. 选择活跃的 Twitter 用户
3. 删除用户重新添加（重置 since_id）

### 问题 4：403 Forbidden 错误

**原因**：
免费版 Twitter API v2 不支持以下端点：
- `GET /2/users/:id/tweets`
- `GET /2/users/by/username/:username`
- `GET /2/tweets/search/recent`

**解决方法**：
必须升级到 Basic 级别（$100/月）

---

## 📊 监控系统工作流程

### 正常流程

```
1. 用户点击"启动监控"
   ↓
2. 检查 Redis 连接
   ↓
3. 调用 Celery 异步任务
   ↓
4. TwitterMonitorService.monitor_all_users()
   ↓
5. 对每个启用的用户：
   - 调用 Twitter API 获取推文
   - 保存到数据库
   - 记录日志
   ↓
6. 定时任务（如果配置了 Celery Beat）
   - 每 N 分钟自动执行一次
```

### 当前状态检查

访问 `/twitter/logs/` 可以看到：
- ✅ 总执行次数
- ✅ 成功/失败次数
- ✅ 抓取的推文数量
- ✅ 详细错误信息
- ✅ 执行时间记录

---

## 🚀 建议的行动计划

### 立即执行（诊断问题）

1. **访问日志页面**
   ```
   /twitter/logs/
   ```

2. **测试 API 连接**
   - 点击"测试 API 连接"按钮
   - 记录错误信息

3. **手动触发监控**
   - 访问 `/twitter/monitor-config/`
   - 点击"启动监控"
   - 返回日志页面查看结果

4. **查看 Twitter Developer Portal**
   - 确认 API 级别
   - 查看使用统计

### 根据诊断结果

**如果是 API 权限问题**：
- 升级到 Basic 级别
- 或等待 Twitter 降低 API 门槛

**如果是配置问题**：
- 在 Railway 添加 Redis
- 配置 Procfile
- 添加 Worker 和 Beat 服务

**如果是代码问题**：
- 查看详细错误日志
- 根据错误信息调整代码

---

## 📝 新增功能

### 1. 日志查看页面
- **URL**: `/twitter/logs/`
- **功能**：
  - 查看所有监控任务执行记录
  - 统计成功/失败次数
  - 显示抓取数据量
  - 显示详细错误信息

### 2. API 测试功能
- **功能**：一键测试 Twitter API 连接
- **位置**：日志页面右上角
- **作用**：
  - 验证 API 密钥是否正确
  - 检查 API 权限级别
  - 快速诊断连接问题

### 3. 监控日志记录
- 每次监控执行都会记录：
  - 执行时间
  - 监控用户
  - 抓取推文数量
  - 抓取回复数量
  - 成功/失败状态
  - 错误信息

---

## 🎯 下一步操作

1. **立即测试**
   ```bash
   # 提交代码
   git add .
   git commit -m "添加日志页面和 API 测试功能"
   git push origin main
   ```

2. **访问新功能**
   ```
   https://你的域名.up.railway.app/twitter/logs/
   ```

3. **点击"测试 API 连接"**
   - 查看返回结果
   - 确认 API 是否可用

4. **查看执行日志**
   - 确认监控任务是否执行
   - 查看具体错误信息

5. **根据结果采取行动**
   - API 不可用 → 升级订阅
   - 任务不执行 → 配置 Celery
   - 有其他错误 → 根据日志修复

---

现在你有完整的诊断工具了！🎉
