# Railway 部署配置说明

## ✅ 已修复：CSRF 错误

### 问题描述
部署到 Railway 后，在添加用户时出现 CSRF 验证失败错误：
```
Forbidden (403)
CSRF verification failed. Request aborted.
Origin checking failed - https://server-production-001a.up.railway.app does not match any trusted origins.
```

### 解决方案

已在 `mysite/settings.py` 中添加 CSRF 可信源配置：

```python
CSRF_TRUSTED_ORIGINS = [
    'https://server-production-001a.up.railway.app',  # 你的 Railway 域名
    'http://localhost:8000',
    'http://127.0.0.1:8000',
]

# 自动从环境变量读取，并确保包含协议 (https://)
railway_url = os.environ.get('RAILWAY_STATIC_URL')
if railway_url:
    if not railway_url.startswith(('http://', 'https://')):
        railway_url = f'https://{railway_url}'
    if railway_url not in CSRF_TRUSTED_ORIGINS:
        CSRF_TRUSTED_ORIGINS.append(railway_url)
```

**重要：**
Django 4.0+ 要求 CSRF_TRUSTED_ORIGINS 中的所有值必须包含协议（http:// 或 https://）。
系统现在会自动为环境变量中的域名添加 https:// 前缀。

### 如何更新

如果你的 Railway 域名发生变化，请按以下步骤更新：

#### 方法 1: 直接修改配置文件

编辑 `mysite/settings.py` 第 34-38 行，更新你的域名：

```python
CSRF_TRUSTED_ORIGINS = [
    'https://你的新域名.up.railway.app',  # 修改这里
    'http://localhost:8000',
    'http://127.0.0.1:8000',
]
```

#### 方法 2: 使用环境变量（推荐）

在 Railway 控制台中添加环境变量：
```
RAILWAY_STATIC_URL=https://你的域名.up.railway.app
```

系统会自动将其添加到可信源列表中。

---

## 📋 完整部署检查清单

### 1. 环境变量配置

在 Railway 控制台中设置以下环境变量：

#### 必需的环境变量：

```bash
# Twitter API 配置
TWITTER_BEARER_TOKEN=你的-bearer-token
TWITTER_API_KEY=你的-api-key
TWITTER_API_SECRET=你的-api-secret
TWITTER_ACCESS_TOKEN=你的-access-token
TWITTER_ACCESS_SECRET=你的-access-secret

# 数据库配置（Railway 会自动提供）
PGDATABASE=数据库名
PGUSER=用户名
PGPASSWORD=密码
PGHOST=主机地址
PGPORT=端口

# Redis 配置（如果使用 Celery）
REDIS_URL=redis://你的redis地址

# Railway 环境标识（自动设置）
RAILWAY_ENVIRONMENT=production
```

#### 可选的环境变量：

```bash
# 自定义域名（如果使用）
RAILWAY_STATIC_URL=https://你的自定义域名.com
```

### 2. 数据库迁移

部署后首次运行，需要执行数据库迁移：

```bash
# Railway 会自动运行这些命令
python manage.py migrate
python manage.py collectstatic --noinput
```

如果需要手动执行，可以在 Railway 控制台的 "Shell" 中运行。

### 3. 创建超级用户

在 Railway Shell 中创建管理员账户：

```bash
python manage.py createsuperuser
```

按提示输入：
- 用户名
- 邮箱
- 密码

### 4. 检查配置

访问以下页面确认部署成功：

- **主页**: `https://你的域名.up.railway.app/`
- **Admin**: `https://你的域名.up.railway.app/admin/`
- **API**: `https://你的域名.up.railway.app/twitter/api/monitored-users/`

---

## 🔧 常见问题解决

### 问题 1: CSRF 错误（已解决）

**错误信息**:
```
CSRF verification failed. Request aborted.
```

**解决方法**:
已在 `settings.py` 中配置 `CSRF_TRUSTED_ORIGINS`，包含你的 Railway 域名。

### 问题 2: 静态文件 404

**症状**: CSS/JS 文件加载失败

**解决方法**:
```bash
# 在 Railway Shell 中运行
python manage.py collectstatic --noinput
```

### 问题 3: 数据库连接错误

**症状**: 无法连接到数据库

**解决方法**:
1. 检查 Railway 是否已添加 PostgreSQL 插件
2. 确认环境变量 `PGDATABASE`, `PGUSER` 等已设置
3. 在 Railway Shell 中测试连接：
   ```bash
   python manage.py dbshell
   ```

### 问题 4: Twitter API 无法使用

**症状**: 添加用户时提示无法找到用户

**原因**: 使用免费版 Twitter API

**解决方法**:
- 升级到 Basic 级别（$100/月）
- 或查看 `Twitter_API_升级指南.md`

---

## 🚀 部署后的操作流程

### 首次部署后：

1. **访问主页**
   ```
   https://server-production-001a.up.railway.app/
   ```

2. **添加监控用户**
   - 点击"添加监控用户"
   - 输入 Twitter 用户名
   - 提交（现在不会再出现 CSRF 错误！）

3. **配置监控**
   - 点击"启动监控"
   - 勾选要监控的用户
   - 选择监控频率
   - 点击"启动监控"按钮

4. **查看数据**
   - 返回主页查看统计
   - 点击用户查看详情

### 日常维护：

- 定期检查监控日志
- 查看统计数据
- 调整监控频率
- 添加/删除用户

---

## 📝 更新代码后的部署

当你在本地修改代码后，推送到 Railway：

```bash
# 1. 提交更改
git add .
git commit -m "修复 CSRF 配置"

# 2. 推送到仓库
git push origin main

# 3. Railway 会自动部署
# 等待几分钟后访问网站
```

---

## 🔒 安全建议

### 生产环境设置

1. **关闭 DEBUG 模式**（可选，但推荐）
   
   在 Railway 环境变量中添加：
   ```
   DEBUG=False
   ```

2. **更改 SECRET_KEY**
   
   生成新的密钥：
   ```python
   from django.core.management.utils import get_random_secret_key
   print(get_random_secret_key())
   ```
   
   在 Railway 环境变量中添加：
   ```
   SECRET_KEY=生成的新密钥
   ```

3. **限制 ALLOWED_HOSTS**（可选）
   
   修改 `settings.py`：
   ```python
   ALLOWED_HOSTS = [
       'server-production-001a.up.railway.app',
       'localhost',
       '127.0.0.1',
   ]
   ```

### API 密钥安全

- ✅ 所有密钥都存储在环境变量中
- ✅ `.env` 文件已在 `.gitignore` 中
- ✅ 不会被提交到 Git 仓库
- ⚠️ 不要在代码中硬编码密钥
- ⚠️ 不要公开分享 `.env` 文件

---

## 📊 监控和日志

### Railway 日志查看

在 Railway 控制台可以查看：
- 部署日志
- 应用日志
- 错误信息

### 应用监控

访问管理后台查看：
- 监控用户数
- 推文数量
- 监控任务执行情况
- 错误日志

---

## 💡 优化建议

### 性能优化

1. **启用数据库连接池**（已配置）
2. **使用 Redis 缓存**（Celery 需要）
3. **优化静态文件** - WhiteNoise 已启用

### 成本优化

1. **合理设置监控频率**
   - 监控用户少：每 15-30 分钟
   - 监控用户多：每 1-3 小时

2. **定期清理旧数据**
   - 系统会自动保留 30 天数据
   - 可在监控配置中调整

3. **监控 Railway 使用量**
   - 查看资源使用情况
   - 避免超出免费额度

---

## 🎯 总结

### 已完成配置：

- ✅ CSRF 可信源已添加
- ✅ Railway 域名已配置
- ✅ 环境变量自动检测
- ✅ 数据库配置完成
- ✅ 静态文件处理已启用

### 下一步：

1. **提交代码到 Git**
2. **推送到 Railway**（自动部署）
3. **等待部署完成**
4. **访问网站测试添加用户**
5. **开始使用监控功能**

---

## 📞 获取帮助

如果遇到其他问题：

1. 查看 Railway 控制台的日志
2. 检查环境变量是否正确设置
3. 确认数据库已正确连接
4. 查看相关文档：
   - `TWITTER_MONITOR_README.md`
   - `Web可视化界面使用指南.md`
   - `Twitter_API_升级指南.md`

---

**现在你的 CSRF 错误已经解决了！** 🎉

重新部署后，添加用户功能应该可以正常使用了。
