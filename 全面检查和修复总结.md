# Twitter ç›‘æ§ç³»ç»Ÿ - å…¨é¢æ£€æŸ¥å’Œä¿®å¤æ€»ç»“

## âœ… å·²å®Œæˆçš„æ”¹è¿›

### 1. æ–°å¢æ—¥å¿—æŸ¥çœ‹é¡µé¢

**æ–‡ä»¶**ï¼š`twitter_monitor/templates/twitter_monitor/logs.html`

**åŠŸèƒ½**ï¼š
- ğŸ“Š æ˜¾ç¤ºç›‘æ§ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡
  - æ€»æ‰§è¡Œæ¬¡æ•°
  - æˆåŠŸ/å¤±è´¥æ¬¡æ•°  
  - æŠ“å–æ¨æ–‡æ€»æ•°
  - æŠ“å–å›å¤æ€»æ•°

- ğŸ“‹ æ˜¾ç¤ºè¯¦ç»†æ‰§è¡Œè®°å½•ï¼ˆæœ€è¿‘ 100 æ¡ï¼‰
  - æ‰§è¡Œç”¨æˆ·
  - æ‰§è¡ŒçŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
  - æŠ“å–æ•°é‡
  - æ‰§è¡Œæ—¶é—´
  - é”™è¯¯ä¿¡æ¯

- ğŸ”§ **API è¿æ¥æµ‹è¯•åŠŸèƒ½**
  - ç‚¹å‡»æŒ‰é’®å³å¯æµ‹è¯•
  - å®æ—¶æ˜¾ç¤ºæµ‹è¯•ç»“æœ
  - å¸®åŠ©è¯Šæ–­ API é—®é¢˜

**è®¿é—®åœ°å€**ï¼š`/twitter/logs/`

### 2. API æµ‹è¯•ç«¯ç‚¹

**æ–‡ä»¶**ï¼š`twitter_monitor/web_views.py` - `test_api()` å‡½æ•°

**åŠŸèƒ½**ï¼š
- æµ‹è¯• Twitter API è¿æ¥
- å°è¯•è·å– @Twitter å®˜æ–¹è´¦å·ä¿¡æ¯
- è¿”å›è¯¦ç»†çš„æµ‹è¯•ç»“æœ

**æµ‹è¯•é€»è¾‘**ï¼š
```python
def test_api(request):
    service = TwitterService()
    user_info = service.get_user_by_username('Twitter')
    
    if user_info:
        return {æˆåŠŸå“åº” + ç”¨æˆ·ä¿¡æ¯}
    else:
        return {å¤±è´¥å“åº” + é”™è¯¯ä¿¡æ¯}
```

### 3. æ—¥å¿—æŸ¥çœ‹å…¥å£

**ä¿®æ”¹æ–‡ä»¶**ï¼š`twitter_monitor/templates/twitter_monitor/dashboard.html`

**æ”¹åŠ¨**ï¼šåœ¨å¿«æ·æ“ä½œä¸­æ·»åŠ "æŸ¥çœ‹æ—¥å¿—"æŒ‰é’®

**æ•ˆæœ**ï¼šç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°ä»ä¸»é¡µè®¿é—®æ—¥å¿—

### 4. URL è·¯ç”±æ›´æ–°

**æ–‡ä»¶**ï¼š`twitter_monitor/urls.py`

**æ–°å¢è·¯ç”±**ï¼š
```python
path('logs/', web_views.logs, name='logs'),
path('test-api/', web_views.test_api, name='test_api'),
```

---

## ğŸ” å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1ï¼šå…è´¹ API æ— æ³•ä½¿ç”¨ç›‘æ§åŠŸèƒ½

**å…³é”®å‘ç°**ï¼š
å½“å‰ä»£ç è°ƒç”¨çš„ Twitter API v2 ç«¯ç‚¹éœ€è¦ **Basic è®¢é˜…çº§åˆ«**ï¼ˆ$100/æœˆï¼‰

**å…·ä½“ç«¯ç‚¹**ï¼š
```python
# services.py ä¸­ä½¿ç”¨çš„ç«¯ç‚¹

# âŒ å…è´¹ç‰ˆä¸å¯ç”¨
client.get_user(username='xxx')           # ç¬¬ 48 è¡Œ
client.get_users_tweets(id='xxx')         # ç¬¬ 86 è¡Œ
client.search_recent_tweets(query='xxx')  # ç¬¬ 134 è¡Œ
```

**éªŒè¯æ–¹æ³•**ï¼š
1. è®¿é—® `/twitter/logs/`
2. ç‚¹å‡»"æµ‹è¯• API è¿æ¥"
3. å¦‚æœè¿”å› 403 é”™è¯¯ï¼Œè¯´æ˜éœ€è¦å‡çº§ API

### é—®é¢˜ 2ï¼šå®šæ—¶ä»»åŠ¡æ— æ³•è‡ªåŠ¨æ‰§è¡Œ

**åŸå› **ï¼š
- Railway ä¸Šåªæœ‰ Web æœåŠ¡åœ¨è¿è¡Œ
- æ²¡æœ‰é…ç½® Celery Worker
- æ²¡æœ‰é…ç½® Celery Beat

**å½±å“**ï¼š
- âœ… æ‰‹åŠ¨ç‚¹å‡»"å¯åŠ¨ç›‘æ§"å¯ä»¥æ‰§è¡Œ
- âŒ æ— æ³•æŒ‰è®¾å®šé¢‘ç‡è‡ªåŠ¨æ‰§è¡Œ
- âŒ å®šæ—¶ä»»åŠ¡é…ç½®ä¸ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š

éœ€è¦åœ¨ Railway åˆ›å»ºé¢å¤–çš„æœåŠ¡ï¼š

**1. åˆ›å»º Procfile**ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
```procfile
web: gunicorn mysite.wsgi:application
worker: celery -A mysite worker --loglevel=info
beat: celery -A mysite beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
```

**2. åœ¨ Railway åˆ›å»º 3 ä¸ªæœåŠ¡**
- **Web** - è¿è¡Œ Djangoï¼ˆå·²æœ‰ï¼‰
- **Worker** - è¿è¡Œ Celery Workerï¼ˆéœ€è¦æ·»åŠ ï¼‰
- **Beat** - è¿è¡Œ Celery Beatï¼ˆéœ€è¦æ·»åŠ ï¼‰

### é—®é¢˜ 3ï¼šRedis è¿æ¥é”™è¯¯å¤„ç†

**å·²ä¿®å¤**ï¼š
åœ¨ `web_views.py` çš„ `start_monitoring()` å‡½æ•°ä¸­æ·»åŠ äº†ä¼˜é›…é™çº§ï¼š

**ä¿®å¤å‰**ï¼š
```python
monitor_all_users_task.delay()  # Redis ä¸å¯ç”¨æ—¶ç›´æ¥æŠ¥é”™
```

**ä¿®å¤å**ï¼š
```python
try:
    monitor_all_users_task.delay()
    task_msg = 'å·²åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—'
except Exception:
    task_msg = 'âš ï¸ å®šæ—¶ä»»åŠ¡æœåŠ¡æœªå¯åŠ¨ï¼Œè¯·åœ¨ Railway æ·»åŠ  Redis æœåŠ¡'
```

---

## ğŸ“Š ç›‘æ§æµç¨‹è¯Šæ–­

### å½“å‰ç›‘æ§æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨ç›‘æ§"
    â†“
æ›´æ–°ç”¨æˆ·çŠ¶æ€ï¼ˆis_active=Trueï¼‰
    â†“
å°è¯•è°ƒç”¨ Celery ä»»åŠ¡
    â†“
â”œâ”€ æˆåŠŸï¼šmonitor_all_users_task.delay()
â”‚    â†“
â”‚    Celery Worker æ‰§è¡Œä»»åŠ¡
â”‚    â†“
â”‚    TwitterMonitorService.monitor_all_users()
â”‚    â†“
â”‚    å¯¹æ¯ä¸ªç”¨æˆ·è°ƒç”¨ Twitter API
â”‚    â†“
â”‚    ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“
â”‚    â†“
â”‚    è®°å½•æ‰§è¡Œæ—¥å¿—ï¼ˆMonitorLogï¼‰
â”‚
â””â”€ å¤±è´¥ï¼šæ˜¾ç¤ºå‹å¥½æç¤º
```

### API è°ƒç”¨æ£€æŸ¥ç‚¹

**services.py - TwitterMonitorService.monitor_user()**

```python
def monitor_user(self, user):
    # 1. è·å–ç”¨æˆ·æ¨æ–‡
    tweets = self.twitter_service.fetch_user_tweets(
        user_id=user.user_id,
        max_results=100,
        since_id=since_id  # å¢é‡æŠ“å–
    )
    
    # 2. ä¿å­˜æ¨æ–‡
    for tweet_data in tweets:
        tweet, created = Tweet.objects.update_or_create(...)
        
        # 3. è·å–æ¨æ–‡å›å¤
        if created:
            replies = self.twitter_service.fetch_tweet_replies(...)
            
            # 4. ä¿å­˜å›å¤
            for reply_data in replies:
                Reply.objects.update_or_create(...)
    
    # 5. è®°å½•æ—¥å¿—
    MonitorLog.objects.create(
        user=user,
        status='success',
        tweets_fetched=tweets_count,
        replies_fetched=replies_count,
    )
```

**é—®é¢˜è¯Šæ–­**ï¼š

å¦‚æœæ—¥å¿—æ˜¾ç¤º `tweets_fetched=0`ï¼Œå¯èƒ½çš„åŸå› ï¼š
1. âŒ API è¿”å›ç©ºæ•°æ®ï¼ˆæƒé™ä¸è¶³ï¼‰
2. âŒ ç”¨æˆ·æœ€è¿‘æ²¡æœ‰å‘æ¨æ–‡
3. âŒ `since_id` è®¾ç½®å¯¼è‡´æ²¡æœ‰æ–°æ¨æ–‡

### API è°ƒç”¨æ¬¡æ•°æ£€æŸ¥

**ä¸ºä»€ä¹ˆ API è°ƒç”¨æ¬¡æ•°æ²¡æœ‰å‡å°‘ï¼Ÿ**

**å¯èƒ½åŸå›  1**ï¼šå…è´¹ API è¯·æ±‚è¢«æ‹’ç»
```python
# è¯·æ±‚å‘é€äº†ï¼Œä½†è¢« Twitter æ‹’ç»
response = client.get_users_tweets(...)
# è¿”å› 403 Forbidden
# ä¸è®¡å…¥æœ‰æ•ˆè°ƒç”¨æ¬¡æ•°
```

**å¯èƒ½åŸå›  2**ï¼šå¼‚å¸¸è¢«æ•è·
```python
try:
    tweets = self.twitter_service.fetch_user_tweets(...)
except Exception as e:
    logger.error(f"è·å–ç”¨æˆ·æ¨æ–‡å¤±è´¥ {user_id}: {str(e)}")
    return []  # è¿”å›ç©ºåˆ—è¡¨ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
```

**å¯èƒ½åŸå›  3**ï¼šç›‘æ§ä»»åŠ¡æ²¡æœ‰å®é™…æ‰§è¡Œ
- Redis æœªå¯åŠ¨
- Celery Worker æœªè¿è¡Œ
- æ‰‹åŠ¨ç‚¹å‡»åæ²¡æœ‰æŸ¥çœ‹æ—¥å¿—

**éªŒè¯æ–¹æ³•**ï¼š
1. è®¿é—® `/twitter/logs/`
2. æŸ¥çœ‹æ˜¯å¦æœ‰æ‰§è¡Œè®°å½•
3. æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯
4. è®¿é—® Twitter Developer Portal æŸ¥çœ‹ API ä½¿ç”¨ç»Ÿè®¡

---

## ğŸ¯ å®Œæ•´è¯Šæ–­æµç¨‹

### ç¬¬ 1 æ­¥ï¼šæµ‹è¯• API è¿æ¥

è®¿é—®ï¼š`/twitter/logs/`

ç‚¹å‡»ï¼š**"æµ‹è¯• API è¿æ¥"**

**æˆåŠŸç¤ºä¾‹**ï¼š
```json
{
  "success": true,
  "message": "API è¿æ¥æˆåŠŸ",
  "result": {
    "user_id": "783214",
    "username": "Twitter",
    "display_name": "Twitter",
    "api_working": true
  }
}
```

**å¤±è´¥ç¤ºä¾‹**ï¼š
```json
{
  "success": false,
  "error": "403 Forbidden - You currently have access to a subset of Twitter API v2 endpoints and limited v1.1 endpoints only"
}
```

### ç¬¬ 2 æ­¥ï¼šæ‰‹åŠ¨è§¦å‘ç›‘æ§

è®¿é—®ï¼š`/twitter/monitor-config/`

æ“ä½œï¼š
1. é€‰æ‹©ä¸€ä¸ªç”¨æˆ·
2. é€‰æ‹©é¢‘ç‡ï¼ˆå¦‚"æ¯ 5 åˆ†é’Ÿ"ï¼‰
3. ç‚¹å‡»"å¯åŠ¨ç›‘æ§"

ç»“æœï¼š
- æˆåŠŸï¼šæ˜¾ç¤º"å·²åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—"
- å¤±è´¥ï¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯

### ç¬¬ 3 æ­¥ï¼šæŸ¥çœ‹æ‰§è¡Œæ—¥å¿—

è¿”å›ï¼š`/twitter/logs/`

æ£€æŸ¥ï¼š
1. æ˜¯å¦æœ‰æ–°çš„æ‰§è¡Œè®°å½•
2. çŠ¶æ€æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥
3. æŠ“å–äº†å¤šå°‘æ¨æ–‡
4. é”™è¯¯ä¿¡æ¯æ˜¯ä»€ä¹ˆ

### ç¬¬ 4 æ­¥ï¼šæ£€æŸ¥æ•°æ®åº“

è®¿é—®ï¼š`/admin/`

æŸ¥çœ‹ï¼š
- **Twitter monitor â€º Monitored users** - ç”¨æˆ·åˆ—è¡¨
- **Twitter monitor â€º Tweets** - æ¨æ–‡æ•°æ®
- **Twitter monitor â€º Monitor logs** - æ‰§è¡Œæ—¥å¿—

### ç¬¬ 5 æ­¥ï¼šæŸ¥çœ‹ Railway æ—¥å¿—

Railway æ§åˆ¶å°ï¼š
1. è¿›å…¥ Web æœåŠ¡
2. ç‚¹å‡» "Deployments"
3. æŸ¥çœ‹æœ€æ–°éƒ¨ç½²çš„æ—¥å¿—
4. æœç´¢å…³é”®è¯ï¼š`ERROR`ã€`Twitter`ã€`403`

---

## ğŸ“‹ å½“å‰ç³»ç»ŸçŠ¶æ€è¯„ä¼°

### âœ… æ­£å¸¸å·¥ä½œçš„åŠŸèƒ½

1. **Web ç•Œé¢**
   - ä¸»æ§åˆ¶å°
   - æ·»åŠ ç”¨æˆ·
   - ç›‘æ§é…ç½®
   - ç”¨æˆ·è¯¦æƒ…
   - API æ–‡æ¡£
   - **æ—¥å¿—æŸ¥çœ‹ï¼ˆæ–°å¢ï¼‰**

2. **æ•°æ®åº“**
   - ç”¨æˆ·æ•°æ®ä¿å­˜
   - æ¨æ–‡æ•°æ®æ¨¡å‹
   - ç›‘æ§æ—¥å¿—è®°å½•

3. **æ‰‹åŠ¨è§¦å‘**
   - ç‚¹å‡»"å¯åŠ¨ç›‘æ§"ç«‹å³æ‰§è¡Œ

4. **é”™è¯¯å¤„ç†**
   - Redis ä¸å¯ç”¨æ—¶çš„å‹å¥½æç¤º
   - API è°ƒç”¨å¤±è´¥çš„æ—¥å¿—è®°å½•

### âš ï¸ éœ€è¦é…ç½®çš„åŠŸèƒ½

1. **Redis æœåŠ¡**
   - çŠ¶æ€ï¼šéœ€è¦åœ¨ Railway æ·»åŠ 
   - å½±å“ï¼šCelery ä»»åŠ¡æ— æ³•æ‰§è¡Œ

2. **Celery Worker**
   - çŠ¶æ€ï¼šæœªé…ç½®
   - å½±å“ï¼šåå°ä»»åŠ¡æ— æ³•å¤„ç†

3. **Celery Beat**
   - çŠ¶æ€ï¼šæœªé…ç½®
   - å½±å“ï¼šå®šæ—¶ä»»åŠ¡æ— æ³•è‡ªåŠ¨æ‰§è¡Œ

4. **Twitter API**
   - çŠ¶æ€ï¼šå¯èƒ½æ˜¯å…è´¹ç‰ˆ
   - å½±å“ï¼šæ— æ³•è·å–æ¨æ–‡æ•°æ®

---

## ğŸš€ å»ºè®®çš„æ“ä½œæ­¥éª¤

### ç«‹å³æ‰§è¡Œï¼ˆè¯Šæ–­é—®é¢˜ï¼‰

1. **æ¨é€ä»£ç **
   ```bash
   git add .
   git commit -m "æ·»åŠ æ—¥å¿—é¡µé¢å’Œ API æµ‹è¯•åŠŸèƒ½ï¼Œå®Œå–„é”™è¯¯å¤„ç†"
   git push origin main
   ```

2. **ç­‰å¾…éƒ¨ç½²å®Œæˆ**ï¼ˆ1-2 åˆ†é’Ÿï¼‰

3. **æµ‹è¯• API è¿æ¥**
   - è®¿é—®ï¼š`https://ä½ çš„åŸŸå/twitter/logs/`
   - ç‚¹å‡»ï¼š**"æµ‹è¯• API è¿æ¥"**
   - æˆªå›¾ä¿å­˜ç»“æœ

4. **æ‰‹åŠ¨è§¦å‘ç›‘æ§**
   - è®¿é—®ï¼š`https://ä½ çš„åŸŸå/twitter/monitor-config/`
   - ç‚¹å‡»ï¼š**"å¯åŠ¨ç›‘æ§"**
   - è¿”å›æ—¥å¿—é¡µé¢æŸ¥çœ‹ç»“æœ

5. **æŸ¥çœ‹ Twitter API ä½¿ç”¨ç»Ÿè®¡**
   - è®¿é—®ï¼šhttps://developer.twitter.com/en/portal/dashboard
   - æŸ¥çœ‹è°ƒç”¨æ¬¡æ•°å˜åŒ–

### æ ¹æ®è¯Šæ–­ç»“æœé‡‡å–è¡ŒåŠ¨

**æƒ…å†µ A**ï¼šAPI æµ‹è¯•æ˜¾ç¤º 403 é”™è¯¯
- **åŸå› **ï¼šå…è´¹ç‰ˆ API æ— æ³•ä½¿ç”¨ç›‘æ§åŠŸèƒ½
- **è§£å†³**ï¼šå‡çº§åˆ° Basic çº§åˆ«ï¼ˆ$100/æœˆï¼‰
- **æ–‡æ¡£**ï¼šæŸ¥çœ‹ `Twitter_API_å‡çº§æŒ‡å—.md`

**æƒ…å†µ B**ï¼šAPI æµ‹è¯•æˆåŠŸï¼Œä½†æ—¥å¿—æ˜¾ç¤º tweets_fetched=0
- **åŸå›  1**ï¼šç”¨æˆ·æœ€è¿‘æ²¡æœ‰å‘æ¨æ–‡
  - è§£å†³ï¼šé€‰æ‹©æ›´æ´»è·ƒçš„ç”¨æˆ·ï¼ˆå¦‚ @elonmuskï¼‰
- **åŸå›  2**ï¼šsince_id è®¾ç½®é—®é¢˜
  - è§£å†³ï¼šåˆ é™¤ç”¨æˆ·é‡æ–°æ·»åŠ 

**æƒ…å†µ C**ï¼šç‚¹å‡»å¯åŠ¨ç›‘æ§åæ²¡æœ‰æ—¥å¿—è®°å½•
- **åŸå› **ï¼šRedis æœªå¯åŠ¨æˆ– Celery æœªé…ç½®
- **è§£å†³**ï¼š
  1. åœ¨ Railway æ·»åŠ  Redis æœåŠ¡
  2. é…ç½® Procfile å’Œ Worker/Beat æœåŠ¡
  - æŸ¥çœ‹æ–‡æ¡£ï¼š`Railway_Redisé…ç½®æŒ‡å—.md`

**æƒ…å†µ D**ï¼šæ—¥å¿—æ˜¾ç¤ºå…¶ä»–é”™è¯¯
- **æ“ä½œ**ï¼šæŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯
- **æ–‡æ¡£**ï¼š`ç³»ç»Ÿè¯Šæ–­å’Œæ£€æŸ¥æ¸…å•.md`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **ç³»ç»Ÿè¯Šæ–­å’Œæ£€æŸ¥æ¸…å•.md** - å®Œæ•´çš„é—®é¢˜è¯Šæ–­æµç¨‹
2. **Railway_Redisé…ç½®æŒ‡å—.md** - Redis å’Œ Celery é…ç½®
3. **ç›‘æ§é¢‘ç‡é…ç½®æ›´æ–°è¯´æ˜.md** - å®šæ—¶ä»»åŠ¡é…ç½®
4. **Twitter_API_å‡çº§æŒ‡å—.md** - API æƒé™å‡çº§è¯´æ˜
5. **éƒ¨ç½²é…ç½®è¯´æ˜.md** - CSRF å’Œéƒ¨ç½²é…ç½®

---

## ğŸ¯ æœŸå¾…ç»“æœ

å®Œæˆä¸Šè¿°è¯Šæ–­åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… **æ˜ç¡®çŸ¥é“** API æ˜¯å¦å¯ç”¨
2. âœ… **çœ‹åˆ°æ—¥å¿—** ç›‘æ§ä»»åŠ¡æ˜¯å¦æ‰§è¡Œ
3. âœ… **äº†è§£é—®é¢˜** å…·ä½“æ˜¯å“ªä¸ªç¯èŠ‚å‡ºé”™
4. âœ… **è·å¾—æ–¹æ¡ˆ** å¦‚ä½•è§£å†³é—®é¢˜

**å…³é”®æŒ‡æ ‡**ï¼š

- è®¿é—® Twitter Developer Portalï¼ŒæŸ¥çœ‹ API è°ƒç”¨ç»Ÿè®¡
- è®¿é—® `/twitter/logs/`ï¼ŒæŸ¥çœ‹ç›‘æ§æ‰§è¡Œè®°å½•
- è®¿é—® `/admin/`ï¼ŒæŸ¥çœ‹æ•°æ®åº“ä¸­çš„æ•°æ®é‡

å¦‚æœè¿™ä¸‰ä¸ªåœ°æ–¹éƒ½æœ‰æ•°æ®å˜åŒ–ï¼Œè¯´æ˜ç›‘æ§ç³»ç»Ÿæ­£å¸¸å·¥ä½œï¼ ğŸ‰

---

**ç°åœ¨è¯·æ¨é€ä»£ç ï¼Œç„¶åæŒ‰ç…§è¯Šæ–­æµç¨‹é€æ­¥æ£€æŸ¥ï¼**
