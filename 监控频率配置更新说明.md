# 监控频率配置功能更新说明

## ✅ 已完成的更新

### 1. 新增 5 分钟监控频率

在监控配置页面新增了"每 5 分钟"的预设选项，现在支持的频率包括：

- **每 5 分钟** ⭐ 新增
- 每 15 分钟
- 每 30 分钟（默认）
- 每 1 小时
- 每 3 小时
- 每 6 小时
- 自定义

### 2. 修复自定义频率功能

**问题**：之前自定义频率的输入框类型设置为 `number`，导致无法输入 Cron 表达式（如 `*/30`、`*` 等）

**修复**：
- 将输入框类型改为 `text`
- 支持标准 Cron 表达式语法
- 可以输入：
  - `*` - 每个值
  - `*/5` - 每 5 个单位
  - `1,3,5` - 指定多个值
  - `1-5` - 值范围

### 3. 实现定时任务动态更新

**新增文件**：[`twitter_monitor/schedule_manager.py`](file:///Users/averson/PycharmProjects/django-Xvfr/twitter_monitor/schedule_manager.py)

这个模块提供了完整的 Celery Beat 定时任务管理功能：

- `update_monitoring_schedule()` - 更新监控频率
- `stop_monitoring_schedule()` - 停止监控任务
- `get_current_schedule()` - 获取当前配置

**功能实现**：
- ✅ 预设频率自动创建 IntervalSchedule
- ✅ 自定义频率自动创建 CrontabSchedule
- ✅ 启动监控时实时更新定时任务
- ✅ 停止监控时禁用定时任务

---

## 📋 使用指南

### 预设频率使用

1. 访问监控配置页面：`/twitter/monitor-config/`
2. 选择要监控的用户（可多选）
3. 选择预设频率（例如"每 5 分钟"）
4. 点击"启动监控"按钮

系统会：
- 立即执行一次监控
- 创建定时任务，按照选择的频率自动执行

### 自定义频率使用

#### 示例 1：每 10 分钟执行一次

```
分钟: */10
小时: *
星期: 每天
```

#### 示例 2：每天早上 9 点执行

```
分钟: 0
小时: 9
星期: 每天
```

#### 示例 3：工作日每 30 分钟执行

```
分钟: */30
小时: *
星期: 工作日
```

#### 示例 4：周末每小时执行

```
分钟: 0
小时: *
星期: 周末
```

#### 示例 5：每 2 小时执行一次

```
分钟: 0
小时: */2
星期: 每天
```

---

## 🔧 技术说明

### Cron 表达式语法

自定义频率使用标准的 Cron 表达式语法：

| 字段 | 允许值 | 特殊字符 |
|-----|--------|---------|
| 分钟 | 0-59 | `*` `,` `-` `/` |
| 小时 | 0-23 | `*` `,` `-` `/` |
| 星期 | 0-6 (0=周日) | `*` `,` `-` `/` |

**特殊字符说明**：
- `*` - 匹配所有值（每个）
- `,` - 分隔多个值（如 `1,3,5`）
- `-` - 指定范围（如 `1-5`）
- `/` - 指定步长（如 `*/10` 表示每 10 个单位）

### 预设频率对应关系

| 预设选项 | 实际配置 | Celery 类型 |
|---------|---------|------------|
| 每 5 分钟 | every=5, period=MINUTES | IntervalSchedule |
| 每 15 分钟 | every=15, period=MINUTES | IntervalSchedule |
| 每 30 分钟 | every=30, period=MINUTES | IntervalSchedule |
| 每 1 小时 | every=60, period=MINUTES | IntervalSchedule |
| 每 3 小时 | every=180, period=MINUTES | IntervalSchedule |
| 每 6 小时 | every=360, period=MINUTES | IntervalSchedule |
| 自定义 | minute/hour/day_of_week | CrontabSchedule |

---

## 🚀 部署后启用定时任务

### 重要提示

定时任务需要 Celery Beat 服务运行才能自动执行。部署后请确保启动以下服务：

### 本地开发环境

```bash
# 终端 1: 启动 Redis
redis-server

# 终端 2: 启动 Celery Worker
celery -A mysite worker --loglevel=info

# 终端 3: 启动 Celery Beat（定时任务调度器）
celery -A mysite beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler

# 终端 4: 启动 Django 服务器
python manage.py runserver
```

### Railway 生产环境

在 Railway 中需要配置多个服务：

#### 方式 1：使用 Procfile（推荐）

在项目根目录创建 `Procfile`：

```procfile
web: gunicorn mysite.wsgi:application
worker: celery -A mysite worker --loglevel=info
beat: celery -A mysite beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
```

然后在 Railway 中创建 3 个服务实例：
- web - 运行 Django
- worker - 运行 Celery Worker
- beat - 运行 Celery Beat

#### 方式 2：使用单进程（不推荐，仅用于测试）

```bash
# 启动命令
gunicorn mysite.wsgi:application & \
celery -A mysite worker --loglevel=info & \
celery -A mysite beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
```

---

## 📊 查看定时任务状态

### Django Admin 后台查看

1. 访问 `/admin/` 登录后台
2. 进入 "Periodic Tasks" 部分
3. 查看任务列表：
   - **Periodic tasks** - 定时任务配置
   - **Interval schedules** - 时间间隔配置
   - **Crontab schedules** - Crontab 配置

### 数据库查看

```python
from django_celery_beat.models import PeriodicTask

# 查看所有定时任务
tasks = PeriodicTask.objects.all()
for task in tasks:
    print(f"任务: {task.name}")
    print(f"状态: {'启用' if task.enabled else '禁用'}")
    if task.interval:
        print(f"频率: 每 {task.interval.every} {task.interval.period}")
    elif task.crontab:
        print(f"Cron: {task.crontab.minute} {task.crontab.hour} * * {task.crontab.day_of_week}")
    print("---")
```

---

## 🐛 常见问题

### Q1: 选择频率后没有效果？

**A**: 请检查：
1. Celery Beat 服务是否在运行
2. Redis 服务是否正常
3. 查看 Celery Beat 日志是否有错误

### Q2: 自定义频率无法保存？

**A**: 确保输入的是有效的 Cron 表达式：
- ✅ 正确：`*/30`, `*`, `0`, `1-5`
- ❌ 错误：`每30分钟`, `all`, 空白

### Q3: 定时任务不执行？

**A**: 按顺序检查：
1. 启用了至少一个用户
2. Celery Worker 正在运行
3. Celery Beat 正在运行
4. 定时任务在 Admin 中显示为"启用"状态
5. 查看 Celery 日志确认任务调度

### Q4: 修改频率后多久生效？

**A**: 
- Celery Beat 默认每 5 秒检查一次数据库
- 修改后通常在 5-10 秒内生效
- 无需重启服务

---

## 📝 更新日志

### 2025-10-25

**新增**：
- ✅ 添加 5 分钟预设频率选项
- ✅ 修复自定义频率输入问题（number → text）
- ✅ 实现定时任务动态更新功能
- ✅ 创建 schedule_manager 模块
- ✅ 集成 Celery Beat 数据库调度器

**修复**：
- ✅ 自定义频率无法输入 Cron 表达式
- ✅ 频率配置不会实际更新定时任务
- ✅ 停止监控后定时任务仍在运行

**改进**：
- ✅ 更清晰的成功提示信息
- ✅ 完整的错误处理
- ✅ 详细的使用文档

---

## 🎯 下一步建议

1. **测试定时任务**
   ```bash
   # 查看 Celery Beat 日志
   celery -A mysite beat --loglevel=debug
   ```

2. **监控执行情况**
   - 查看 Admin 后台的监控日志
   - 检查推文数据是否定期更新

3. **优化配置**
   - 根据实际需求调整监控频率
   - 避免频率过高导致 API 限额

4. **生产部署**
   - 在 Railway 配置 Procfile
   - 启动 Worker 和 Beat 服务
   - 监控资源使用情况

---

现在你可以：
1. 使用新增的 5 分钟频率选项
2. 自定义任意监控频率（支持完整 Cron 语法）
3. 配置会实际更新 Celery Beat 定时任务

**祝使用愉快！** 🎉
